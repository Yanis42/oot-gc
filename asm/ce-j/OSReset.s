# OSReset.c
.include "macros.inc"

.section .text, "ax"

.balign 4

glabel OSRegisterResetFunction
/* 09A888 8009FE28 80AD8B58 */  lwz     r5, ResetFunctionQueue@sda21(r13)
/* 09A88C 8009FE2C 48000008 */  b       lbl_8009FE34
lbl_8009FE30:
/* 09A890 8009FE30 80A50008 */  lwz     r5, 8(r5)
lbl_8009FE34:
/* 09A894 8009FE34 28050000 */  cmplwi  r5, 0
/* 09A898 8009FE38 41820014 */  beq     lbl_8009FE4C
/* 09A89C 8009FE3C 80850004 */  lwz     r4, 4(r5)
/* 09A8A0 8009FE40 80030004 */  lwz     r0, 4(r3)
/* 09A8A4 8009FE44 7C040040 */  cmplw   r4, r0
/* 09A8A8 8009FE48 4081FFE8 */  ble     lbl_8009FE30
lbl_8009FE4C:
/* 09A8AC 8009FE4C 28050000 */  cmplwi  r5, 0
/* 09A8B0 8009FE50 40820034 */  bne     lbl_8009FE84
/* 09A8B4 8009FE54 38AD8B58 */  addi    r5, r13, ResetFunctionQueue@sda21
/* 09A8B8 8009FE58 84850004 */  lwzu    r4, 4(r5)
/* 09A8BC 8009FE5C 28040000 */  cmplwi  r4, 0
/* 09A8C0 8009FE60 4082000C */  bne     lbl_8009FE6C
/* 09A8C4 8009FE64 906D8B58 */  stw     r3, ResetFunctionQueue@sda21(r13)
/* 09A8C8 8009FE68 48000008 */  b       lbl_8009FE70
lbl_8009FE6C:
/* 09A8CC 8009FE6C 90640008 */  stw     r3, 8(r4)
lbl_8009FE70:
/* 09A8D0 8009FE70 9083000C */  stw     r4, 0xc(r3)
/* 09A8D4 8009FE74 38000000 */  li      r0, 0
/* 09A8D8 8009FE78 90030008 */  stw     r0, 8(r3)
/* 09A8DC 8009FE7C 90650000 */  stw     r3, 0(r5)
/* 09A8E0 8009FE80 4E800020 */  blr     
lbl_8009FE84:
/* 09A8E4 8009FE84 90A30008 */  stw     r5, 8(r3)
/* 09A8E8 8009FE88 8085000C */  lwz     r4, 0xc(r5)
/* 09A8EC 8009FE8C 9065000C */  stw     r3, 0xc(r5)
/* 09A8F0 8009FE90 28040000 */  cmplwi  r4, 0
/* 09A8F4 8009FE94 9083000C */  stw     r4, 0xc(r3)
/* 09A8F8 8009FE98 4082000C */  bne     lbl_8009FEA4
/* 09A8FC 8009FE9C 906D8B58 */  stw     r3, ResetFunctionQueue@sda21(r13)
/* 09A900 8009FEA0 4E800020 */  blr     
lbl_8009FEA4:
/* 09A904 8009FEA4 90640008 */  stw     r3, 8(r4)
/* 09A908 8009FEA8 4E800020 */  blr     

Reset:
/* 09A90C 8009FEAC 48000020 */  b       lbl_8009FECC
lbl_8009FEB0:
/* 09A910 8009FEB0 7D10FAA6 */  mfspr   r8, 0x3f0
/* 09A914 8009FEB4 61080008 */  ori     r8, r8, 8
/* 09A918 8009FEB8 7D10FBA6 */  mtspr   0x3f0, r8
/* 09A91C 8009FEBC 4C00012C */  isync   
/* 09A920 8009FEC0 7C0004AC */  sync    0
/* 09A924 8009FEC4 60000000 */  nop     
/* 09A928 8009FEC8 48000008 */  b       lbl_8009FED0
lbl_8009FECC:
/* 09A92C 8009FECC 48000020 */  b       lbl_8009FEEC
lbl_8009FED0:
/* 09A930 8009FED0 7CAC42E6 */  mftb    r5, 0x10c
lbl_8009FED4:
/* 09A934 8009FED4 7CCC42E6 */  mftb    r6, 0x10c
/* 09A938 8009FED8 7CE53050 */  subf    r7, r5, r6
/* 09A93C 8009FEDC 28071124 */  cmplwi  r7, 0x1124
/* 09A940 8009FEE0 4180FFF4 */  blt     lbl_8009FED4
/* 09A944 8009FEE4 60000000 */  nop     
/* 09A948 8009FEE8 48000008 */  b       lbl_8009FEF0
lbl_8009FEEC:
/* 09A94C 8009FEEC 48000020 */  b       lbl_8009FF0C
lbl_8009FEF0:
/* 09A950 8009FEF0 3D00CC00 */  lis     r8, PI_REGS_BASE@ha
/* 09A954 8009FEF4 61083000 */  ori     r8, r8, PI_REGS_BASE@l
/* 09A958 8009FEF8 38800003 */  li      r4, 3
/* 09A95C 8009FEFC 90880024 */  stw     r4, PI_24(r8)
/* 09A960 8009FF00 90680024 */  stw     r3, PI_24(r8)
/* 09A964 8009FF04 60000000 */  nop     
/* 09A968 8009FF08 48000008 */  b       lbl_8009FF10
lbl_8009FF0C:
/* 09A96C 8009FF0C 4800000C */  b       lbl_8009FF18
lbl_8009FF10:
/* 09A970 8009FF10 60000000 */  nop     
/* 09A974 8009FF14 4BFFFFFC */  b       lbl_8009FF10
lbl_8009FF18:
/* 09A978 8009FF18 4BFFFF98 */  b       lbl_8009FEB0

glabel __OSDoHotReset
/* 09A97C 8009FF1C 7C0802A6 */  mflr    r0
/* 09A980 8009FF20 90010004 */  stw     r0, 4(r1)
/* 09A984 8009FF24 9421FFE8 */  stwu    r1, -0x18(r1)
/* 09A988 8009FF28 93E10014 */  stw     r31, 0x14(r1)
/* 09A98C 8009FF2C 7C7F1B78 */  mr      r31, r3
/* 09A990 8009FF30 4BFFEDCD */  bl      OSDisableInterrupts
/* 09A994 8009FF34 3C60CC00 */  lis     r3, VI_REGS_BASE@ha
/* 09A998 8009FF38 38632000 */  addi    r3, r3, VI_REGS_BASE@l
/* 09A99C 8009FF3C 38000000 */  li      r0, 0
/* 09A9A0 8009FF40 B0030002 */  sth     r0, VI_DCR(r3)
/* 09A9A4 8009FF44 4BFFD925 */  bl      ICFlashInvalidate
/* 09A9A8 8009FF48 57E31838 */  slwi    r3, r31, 3
/* 09A9AC 8009FF4C 4BFFFF61 */  bl      Reset
/* 09A9B0 8009FF50 8001001C */  lwz     r0, 0x1c(r1)
/* 09A9B4 8009FF54 83E10014 */  lwz     r31, 0x14(r1)
/* 09A9B8 8009FF58 38210018 */  addi    r1, r1, 0x18
/* 09A9BC 8009FF5C 7C0803A6 */  mtlr    r0
/* 09A9C0 8009FF60 4E800020 */  blr     

glabel OSResetSystem
/* 09A9C4 8009FF64 7C0802A6 */  mflr    r0
/* 09A9C8 8009FF68 90010004 */  stw     r0, 4(r1)
/* 09A9CC 8009FF6C 9421FFC0 */  stwu    r1, -0x40(r1)
/* 09A9D0 8009FF70 BF410028 */  stmw    r26, 0x28(r1)
/* 09A9D4 8009FF74 7C7C1B78 */  mr      r28, r3
/* 09A9D8 8009FF78 7C9D2378 */  mr      r29, r4
/* 09A9DC 8009FF7C 7CBE2B78 */  mr      r30, r5
/* 09A9E0 8009FF80 480012D1 */  bl      OSDisableScheduler
/* 09A9E4 8009FF84 4BFFD6E1 */  bl      __OSStopAudioSystem
/* 09A9E8 8009FF88 2C1C0002 */  cmpwi   r28, 2
/* 09A9EC 8009FF8C 41820018 */  beq     lbl_8009FFA4
/* 09A9F0 8009FF90 2C1C0000 */  cmpwi   r28, 0
/* 09A9F4 8009FF94 4082001C */  bne     lbl_8009FFB0
/* 09A9F8 8009FF98 800D8B60 */  lwz     r0, bootThisDol@sda21(r13)
/* 09A9FC 8009FF9C 28000000 */  cmplwi  r0, 0
/* 09AA00 8009FFA0 41820010 */  beq     lbl_8009FFB0
lbl_8009FFA4:
/* 09AA04 8009FFA4 38600001 */  li      r3, 1
/* 09AA08 8009FFA8 48011869 */  bl      __PADDisableRecalibration
/* 09AA0C 8009FFAC 7C7F1B78 */  mr      r31, r3
lbl_8009FFB0:
/* 09AA10 8009FFB0 48000004 */  b       lbl_8009FFB4
lbl_8009FFB4:
/* 09AA14 8009FFB4 48000004 */  b       lbl_8009FFB8
lbl_8009FFB8:
/* 09AA18 8009FFB8 834D8B58 */  lwz     r26, ResetFunctionQueue@sda21(r13)
/* 09AA1C 8009FFBC 3B600000 */  li      r27, 0
/* 09AA20 8009FFC0 48000004 */  b       lbl_8009FFC4
lbl_8009FFC4:
/* 09AA24 8009FFC4 48000004 */  b       lbl_8009FFC8
lbl_8009FFC8:
/* 09AA28 8009FFC8 48000024 */  b       lbl_8009FFEC
lbl_8009FFCC:
/* 09AA2C 8009FFCC 38600000 */  li      r3, 0
/* 09AA30 8009FFD0 819A0000 */  lwz     r12, 0(r26)
/* 09AA34 8009FFD4 7D8803A6 */  mtlr    r12
/* 09AA38 8009FFD8 4E800021 */  blrl    
/* 09AA3C 8009FFDC 7C600034 */  cntlzw  r0, r3
/* 09AA40 8009FFE0 835A0008 */  lwz     r26, 8(r26)
/* 09AA44 8009FFE4 5400D97E */  srwi    r0, r0, 5
/* 09AA48 8009FFE8 7F7B0378 */  or      r27, r27, r0
lbl_8009FFEC:
/* 09AA4C 8009FFEC 281A0000 */  cmplwi  r26, 0
/* 09AA50 8009FFF0 4182000C */  beq     lbl_8009FFFC
/* 09AA54 8009FFF4 2C1B0000 */  cmpwi   r27, 0
/* 09AA58 8009FFF8 4182FFD4 */  beq     lbl_8009FFCC
lbl_8009FFFC:
/* 09AA5C 8009FFFC 48000CCD */  bl      __OSSyncSram
/* 09AA60 800A0000 7C600034 */  cntlzw  r0, r3
/* 09AA64 800A0004 5400D97E */  srwi    r0, r0, 5
/* 09AA68 800A0008 7F7B0378 */  or      r27, r27, r0
/* 09AA6C 800A000C 2C1B0000 */  cmpwi   r27, 0
/* 09AA70 800A0010 4182000C */  beq     lbl_800A001C
/* 09AA74 800A0014 38000000 */  li      r0, 0
/* 09AA78 800A0018 48000008 */  b       lbl_800A0020
lbl_800A001C:
/* 09AA7C 800A001C 38000001 */  li      r0, 1
lbl_800A0020:
/* 09AA80 800A0020 2C000000 */  cmpwi   r0, 0
/* 09AA84 800A0024 4182FF94 */  beq     lbl_8009FFB8
/* 09AA88 800A0028 2C1C0001 */  cmpwi   r28, 1
/* 09AA8C 800A002C 40820038 */  bne     lbl_800A0064
/* 09AA90 800A0030 2C1E0000 */  cmpwi   r30, 0
/* 09AA94 800A0034 41820030 */  beq     lbl_800A0064
/* 09AA98 800A0038 48000855 */  bl      __OSLockSram
/* 09AA9C 800A003C 88030013 */  lbz     r0, 0x13(r3)
/* 09AAA0 800A0040 60000040 */  ori     r0, r0, 0x40
/* 09AAA4 800A0044 98030013 */  stb     r0, 0x13(r3)
/* 09AAA8 800A0048 38600001 */  li      r3, 1
/* 09AAAC 800A004C 48000C35 */  bl      __OSUnlockSram
/* 09AAB0 800A0050 48000004 */  b       lbl_800A0054
lbl_800A0054:
/* 09AAB4 800A0054 48000004 */  b       lbl_800A0058
lbl_800A0058:
/* 09AAB8 800A0058 48000C71 */  bl      __OSSyncSram
/* 09AABC 800A005C 2C030000 */  cmpwi   r3, 0
/* 09AAC0 800A0060 4182FFF8 */  beq     lbl_800A0058
lbl_800A0064:
/* 09AAC4 800A0064 4BFFEC99 */  bl      OSDisableInterrupts
/* 09AAC8 800A0068 836D8B58 */  lwz     r27, ResetFunctionQueue@sda21(r13)
/* 09AACC 800A006C 3B400000 */  li      r26, 0
/* 09AAD0 800A0070 48000004 */  b       lbl_800A0074
lbl_800A0074:
/* 09AAD4 800A0074 48000004 */  b       lbl_800A0078
lbl_800A0078:
/* 09AAD8 800A0078 48000024 */  b       lbl_800A009C
lbl_800A007C:
/* 09AADC 800A007C 38600001 */  li      r3, 1
/* 09AAE0 800A0080 819B0000 */  lwz     r12, 0(r27)
/* 09AAE4 800A0084 7D8803A6 */  mtlr    r12
/* 09AAE8 800A0088 4E800021 */  blrl    
/* 09AAEC 800A008C 7C600034 */  cntlzw  r0, r3
/* 09AAF0 800A0090 837B0008 */  lwz     r27, 8(r27)
/* 09AAF4 800A0094 5400D97E */  srwi    r0, r0, 5
/* 09AAF8 800A0098 7F5A0378 */  or      r26, r26, r0
lbl_800A009C:
/* 09AAFC 800A009C 281B0000 */  cmplwi  r27, 0
/* 09AB00 800A00A0 4182000C */  beq     lbl_800A00AC
/* 09AB04 800A00A4 2C1A0000 */  cmpwi   r26, 0
/* 09AB08 800A00A8 4182FFD4 */  beq     lbl_800A007C
lbl_800A00AC:
/* 09AB0C 800A00AC 48000C1D */  bl      __OSSyncSram
/* 09AB10 800A00B0 4BFFD8E1 */  bl      LCDisable
/* 09AB14 800A00B4 2C1C0001 */  cmpwi   r28, 1
/* 09AB18 800A00B8 40820028 */  bne     lbl_800A00E0
/* 09AB1C 800A00BC 4BFFEC41 */  bl      OSDisableInterrupts
/* 09AB20 800A00C0 3C60CC00 */  lis     r3, VI_REGS_BASE@ha
/* 09AB24 800A00C4 38632000 */  addi    r3, r3, VI_REGS_BASE@l
/* 09AB28 800A00C8 38000000 */  li      r0, 0
/* 09AB2C 800A00CC B0030002 */  sth     r0, VI_DCR(r3)
/* 09AB30 800A00D0 4BFFD799 */  bl      ICFlashInvalidate
/* 09AB34 800A00D4 57A31838 */  slwi    r3, r29, 3
/* 09AB38 800A00D8 4BFFFDD5 */  bl      Reset
/* 09AB3C 800A00DC 4800007C */  b       lbl_800A0158
lbl_800A00E0:
/* 09AB40 800A00E0 2C1C0000 */  cmpwi   r28, 0
/* 09AB44 800A00E4 40820074 */  bne     lbl_800A0158
/* 09AB48 800A00E8 800D8B60 */  lwz     r0, bootThisDol@sda21(r13)
/* 09AB4C 800A00EC 3C608000 */  lis     r3, 0x8000
/* 09AB50 800A00F0 28000000 */  cmplwi  r0, 0
/* 09AB54 800A00F4 900330EC */  stw     r0, 0x30ec(r3)
/* 09AB58 800A00F8 4182000C */  beq     lbl_800A0104
/* 09AB5C 800A00FC 7FE3FB78 */  mr      r3, r31
/* 09AB60 800A0100 48011711 */  bl      __PADDisableRecalibration
lbl_800A0104:
/* 09AB64 800A0104 3C608000 */  lis     r3, 0x8000
/* 09AB68 800A0108 806300DC */  lwz     r3, 0xdc(r3)
/* 09AB6C 800A010C 48000004 */  b       lbl_800A0110
lbl_800A0110:
/* 09AB70 800A0110 48000004 */  b       lbl_800A0114
lbl_800A0114:
/* 09AB74 800A0114 4800002C */  b       lbl_800A0140
lbl_800A0118:
/* 09AB78 800A0118 A00302C8 */  lhz     r0, 0x2c8(r3)
/* 09AB7C 800A011C 834302FC */  lwz     r26, 0x2fc(r3)
/* 09AB80 800A0120 2C000004 */  cmpwi   r0, 4
/* 09AB84 800A0124 41820014 */  beq     lbl_800A0138
/* 09AB88 800A0128 40800014 */  bge     lbl_800A013C
/* 09AB8C 800A012C 2C000001 */  cmpwi   r0, 1
/* 09AB90 800A0130 41820008 */  beq     lbl_800A0138
/* 09AB94 800A0134 48000008 */  b       lbl_800A013C
lbl_800A0138:
/* 09AB98 800A0138 48001921 */  bl      OSCancelThread
lbl_800A013C:
/* 09AB9C 800A013C 7F43D378 */  mr      r3, r26
lbl_800A0140:
/* 09ABA0 800A0140 28030000 */  cmplwi  r3, 0
/* 09ABA4 800A0144 4082FFD4 */  bne     lbl_800A0118
/* 09ABA8 800A0148 48001149 */  bl      OSEnableScheduler
/* 09ABAC 800A014C 7FA3EB78 */  mr      r3, r29
/* 09ABB0 800A0150 7FC4F378 */  mr      r4, r30
/* 09ABB4 800A0154 4BFFF995 */  bl      __OSReboot
lbl_800A0158:
/* 09ABB8 800A0158 3C608000 */  lis     r3, 0x8000
/* 09ABBC 800A015C 806300DC */  lwz     r3, 0xdc(r3)
/* 09ABC0 800A0160 48000004 */  b       lbl_800A0164
lbl_800A0164:
/* 09ABC4 800A0164 48000004 */  b       lbl_800A0168
lbl_800A0168:
/* 09ABC8 800A0168 4800002C */  b       lbl_800A0194
lbl_800A016C:
/* 09ABCC 800A016C A00302C8 */  lhz     r0, 0x2c8(r3)
/* 09ABD0 800A0170 834302FC */  lwz     r26, 0x2fc(r3)
/* 09ABD4 800A0174 2C000004 */  cmpwi   r0, 4
/* 09ABD8 800A0178 41820014 */  beq     lbl_800A018C
/* 09ABDC 800A017C 40800014 */  bge     lbl_800A0190
/* 09ABE0 800A0180 2C000001 */  cmpwi   r0, 1
/* 09ABE4 800A0184 41820008 */  beq     lbl_800A018C
/* 09ABE8 800A0188 48000008 */  b       lbl_800A0190
lbl_800A018C:
/* 09ABEC 800A018C 480018CD */  bl      OSCancelThread
lbl_800A0190:
/* 09ABF0 800A0190 7F43D378 */  mr      r3, r26
lbl_800A0194:
/* 09ABF4 800A0194 28030000 */  cmplwi  r3, 0
/* 09ABF8 800A0198 4082FFD4 */  bne     lbl_800A016C
/* 09ABFC 800A019C 3F808000 */  lis     r28, 0x8000
/* 09AC00 800A01A0 387C0040 */  addi    r3, r28, 0x40
/* 09AC04 800A01A4 38800000 */  li      r4, 0
/* 09AC08 800A01A8 38A0008C */  li      r5, 0x8c
/* 09AC0C 800A01AC 4BF65225 */  bl      memset
/* 09AC10 800A01B0 387C00D4 */  addi    r3, r28, 0xd4
/* 09AC14 800A01B4 38800000 */  li      r4, 0
/* 09AC18 800A01B8 38A00014 */  li      r5, 0x14
/* 09AC1C 800A01BC 4BF65215 */  bl      memset
/* 09AC20 800A01C0 387C00F4 */  addi    r3, r28, 0xf4
/* 09AC24 800A01C4 38800000 */  li      r4, 0
/* 09AC28 800A01C8 38A00004 */  li      r5, 4
/* 09AC2C 800A01CC 4BF65205 */  bl      memset
/* 09AC30 800A01D0 387C3000 */  addi    r3, r28, 0x3000
/* 09AC34 800A01D4 38800000 */  li      r4, 0
/* 09AC38 800A01D8 38A000C0 */  li      r5, 0xc0
/* 09AC3C 800A01DC 4BF651F5 */  bl      memset
/* 09AC40 800A01E0 387C30C8 */  addi    r3, r28, 0x30c8
/* 09AC44 800A01E4 38800000 */  li      r4, 0
/* 09AC48 800A01E8 38A0000C */  li      r5, 0xc
/* 09AC4C 800A01EC 4BF651E5 */  bl      memset
/* 09AC50 800A01F0 387C30E2 */  addi    r3, r28, 0x30e2
/* 09AC54 800A01F4 38800000 */  li      r4, 0
/* 09AC58 800A01F8 38A00001 */  li      r5, 1
/* 09AC5C 800A01FC 4BF651D5 */  bl      memset
/* 09AC60 800A0200 7FE3FB78 */  mr      r3, r31
/* 09AC64 800A0204 4801160D */  bl      __PADDisableRecalibration
/* 09AC68 800A0208 BB410028 */  lmw     r26, 0x28(r1)
/* 09AC6C 800A020C 80010044 */  lwz     r0, 0x44(r1)
/* 09AC70 800A0210 38210040 */  addi    r1, r1, 0x40
/* 09AC74 800A0214 7C0803A6 */  mtlr    r0
/* 09AC78 800A0218 4E800020 */  blr     

glabel OSGetResetCode
/* 09AC7C 800A021C 3C608000 */  lis     r3, 0x8000
/* 09AC80 800A0220 880330E2 */  lbz     r0, 0x30e2(r3)
/* 09AC84 800A0224 28000000 */  cmplwi  r0, 0
/* 09AC88 800A0228 4182000C */  beq     lbl_800A0234
/* 09AC8C 800A022C 3C608000 */  lis     r3, 0x8000
/* 09AC90 800A0230 48000018 */  b       lbl_800A0248
lbl_800A0234:
/* 09AC94 800A0234 3C60CC00 */  lis     r3, PI_REGS_BASE@ha
/* 09AC98 800A0238 38633000 */  addi    r3, r3, PI_REGS_BASE@l
/* 09AC9C 800A023C 80030024 */  lwz     r0, PI_24(r3)
/* 09ACA0 800A0240 54000038 */  rlwinm  r0, r0, 0, 0, 0x1c
/* 09ACA4 800A0244 5403E8FE */  srwi    r3, r0, 3
lbl_800A0248:
/* 09ACA8 800A0248 4E800020 */  blr     

.section .sbss, "wa"

.balign 8

/* 000F1AB8 80135838 0008 */
ResetFunctionQueue:
    .skip 8

/* 000F1AC0 80135840 0004 */
bootThisDol:
    .skip 4
